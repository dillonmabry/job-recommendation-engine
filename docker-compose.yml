version: '3'

services:
  redis:
    image: 'redis:3.0-alpine'
    command: redis-server
    volumes:
      - 'redis:/data'
    ports:
      - '6379:6379'
    networks:
      - proxy

  flask:
    deploy:
      replicas: 3
    entrypoint: python3
    image: searchapp_flask
    command: app.py
    environment:
      PYTHONUNBUFFERED: 'true'
    volumes:
      - '.:/searchapp'
    ports:
      - '12344:12344'
    networks:
      - proxy

  celery:
    deploy:
      replicas: 3
    entrypoint: celery
    image: searchapp_celery
    command: -A worker worker --loglevel=debug
    volumes:
      - '.:/searchapp'
    networks:
      - proxy
  
  traefik:
    image: traefik
    command: --docker
    ports:
      - 80:80
      - 443:443
    networks:
      - proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /opt/traefik/traefik.toml:/traefik.toml
      - /opt/traefik/certs/:/certs/

  nginx:
    deploy:
      replicas: 3
    image: searchapp_nginx
    volumes:
     - '.:/searchapp'
    networks:
     - proxy
    labels:
      - traefik.port=80
      - traefik.backend=nginx
      - traefik.frontend.passHostHeader=true
      - traefik.enable=true
      - traefik.docker.network=proxy

networks:
  proxy:

volumes:
  redis:
